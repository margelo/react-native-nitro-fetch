# Swift Compiler Bug Solution - Builder Pattern

## Problem

The Swift compiler crashes when a bridged function (generated by Nitrogen) has **4 or more callback parameters**. This is a Swift compiler bug that occurs during the `SerializeSILPass` phase.

### Testing Results

- ✅ **1-3 callbacks**: Works perfectly
- ❌ **4+ callbacks**: Swift compiler crash

## Solution: Builder Pattern

We restructured the API to use a **builder pattern with setter methods** instead of passing all callbacks as constructor parameters.

### Before (Broken)

```typescript
// ❌ 6 callbacks = Swift compiler crash
cronet.newUrlRequestBuilder(
  url,
  onSucceeded,
  onFailed,
  onCanceled,
  onRedirectReceived,
  onResponseStarted,
  onReadCompleted // 6th callback triggers crash
);
```

### After (Fixed)

```typescript
// ✅ Each setter only takes 1 callback = No crash!
const builder = cronet.newUrlRequestBuilder(url);
builder.onSucceeded((info) => console.log('Success!', info));
builder.onFailed((info, error) => console.error('Failed!', error));
builder.onCanceled((info) => console.log('Canceled'));
builder.onRedirectReceived((info, newUrl) => console.log('Redirected'));
builder.onResponseStarted((info) => console.log('Started'));
builder.onReadCompleted((info, buffer) => console.log('Data chunk received'));
builder.setHttpMethod('GET');
builder.addHeader('Authorization', 'Bearer token');
const request = builder.build();
request.start();
```

## API Changes

### TypeScript Spec (`NitroCronet.nitro.ts`)

```typescript
export interface NitroCronet
  extends HybridObject<{ android: 'kotlin'; ios: 'swift' }> {
  // Only takes URL parameter now
  newUrlRequestBuilder(url: string): UrlRequestBuilder;
}

export interface UrlRequestBuilder
  extends HybridObject<{ android: 'kotlin'; ios: 'swift' }> {
  // Request configuration
  setHttpMethod(httpMethod: string): void;
  addHeader(name: string, value: string): void;
  setUploadDataProvider(provider: UploadDataProvider): void;
  setUploadBody(body: ArrayBuffer | string): void;
  disableCache(): void;
  setPriority(priority: number): void;
  allowDirectExecutor(): void;

  // Callback setters (each takes only 1 callback)
  onSucceeded(callback: (info: UrlResponseInfo) => void): void;
  onFailed(
    callback: (
      info: UrlResponseInfo | undefined,
      error: RequestException
    ) => void
  ): void;
  onCanceled(callback: (info: UrlResponseInfo | undefined) => void): void;
  onRedirectReceived(
    callback: (info: UrlResponseInfo, newLocationUrl: string) => void
  ): void;
  onResponseStarted(callback: (info: UrlResponseInfo) => void): void;
  onReadCompleted(
    callback: (info: UrlResponseInfo, byteBuffer: ArrayBuffer) => void
  ): void;

  build(): UrlRequest;
}
```

### iOS Implementation

#### `HybridNitroCronet.swift`

```swift
func newUrlRequestBuilder(url: String) throws -> any HybridUrlRequestBuilderSpec {
  return HybridUrlRequestBuilder(
    url: url,
    session: HybridNitroCronet.session,
    executor: HybridNitroCronet.executorQueue
  )
}
```

#### `HybridUrlRequestBuilder.swift`

```swift
class HybridUrlRequestBuilder: HybridUrlRequestBuilderSpec {
  // Callbacks stored as optionals
  private var onSucceededCallback: ((_ info: UrlResponseInfo) -> Void)?
  private var onFailedCallback: ((_ info: UrlResponseInfo?, _ error: RequestException) -> Void)?
  // ... etc

  // Setter methods
  func onSucceeded(callback: @escaping (_ info: UrlResponseInfo) -> Void) {
    self.onSucceededCallback = callback
  }

  func onFailed(callback: @escaping (_ info: UrlResponseInfo?, _ error: RequestException) -> Void) {
    self.onFailedCallback = callback
  }

  // ... etc
}
```

### Android Implementation

#### `NitroCronet.kt`

```kotlin
override fun newUrlRequestBuilder(url: String): HybridUrlRequestBuilderSpec {
  return NitroUrlRequestBuilder(
    engine = getOrCreateCronetEngine(),
    url = url,
    executor = ioExecutor
  )
}
```

#### `NitroUrlRequestBuilder.kt`

```kotlin
class NitroUrlRequestBuilder(
  private val engine: CronetEngine,
  private val url: String,
  private val executor: JavaExecutor
) : HybridUrlRequestBuilderSpec() {

  // Callbacks stored as nullable vars
  private var onSucceededCallback: ((UrlResponseInfo) -> Unit)? = null
  private var onFailedCallback: ((UrlResponseInfo?, RequestException) -> Unit)? = null
  // ... etc

  // Setter methods
  override fun onSucceeded(callback: (info: UrlResponseInfo) -> Unit) {
    this.onSucceededCallback = callback
  }

  override fun onFailed(callback: (info: UrlResponseInfo?, error: RequestException) -> Unit) {
    this.onFailedCallback = callback
  }

  // ... etc
}
```

## Benefits

1. **✅ Avoids Swift Compiler Bug**: Each setter method only has 1 callback parameter
2. **✅ Unlimited Callbacks**: Can have as many callbacks as needed without hitting the limit
3. **✅ Cleaner API**: More readable and maintainable
4. **✅ Optional Callbacks**: Only set the callbacks you need
5. **✅ Type Safe**: Full type safety with ArrayBuffer and custom types
6. **✅ Streaming Support**: `onReadCompleted` works with ArrayBuffer chunks

## Migration Guide

### Old Code

```typescript
const request = cronet.newUrlRequestBuilder(
  url,
  (info) => console.log('Success'),
  (info, error) => console.error('Failed'),
  (info) => console.log('Canceled')
);
```

### New Code

```typescript
const builder = cronet.newUrlRequestBuilder(url);
builder.onSucceeded((info) => console.log('Success'));
builder.onFailed((info, error) => console.error('Failed'));
builder.onCanceled((info) => console.log('Canceled'));
const request = builder.build();
```

## Technical Details

### Swift Compiler Crash Details

- **Error**: `Command SwiftCompile failed with a nonzero exit code`
- **Phase**: `SerializeSILPass` during `USRGenerationRequest`
- **Trigger**: 4+ callback parameters in bridged function signature
- **Workaround**: Use builder pattern with individual setter methods

### Files Changed

- `src/NitroCronet.nitro.ts` - Updated spec with builder pattern
- `ios/HybridNitroCronet.swift` - Simplified constructor
- `ios/HybridUrlRequestBuilder.swift` - Added callback setters
- `ios/HybridUploadDataSink.swift` - Created implementation
- `android/src/main/java/com/margelo/nitro/nitrofetch/NitroCronet.kt` - Simplified constructor
- `android/src/main/java/com/margelo/nitro/nitrofetch/NitroUrlRequestBuilder.kt` - Added callback setters
- `android/src/main/java/com/margelo/nitro/nitrofetch/HybridUploadDataSink.kt` - Created implementation

## Related Issues

- GitHub Issue: https://github.com/mrousavy/nitro/issues/975
- Swift Bug Report: (waiting for Apple confirmation)

## Testing

Run `yarn nitrogen` to regenerate code, then build both iOS and Android to verify the fix works.

```bash
yarn nitrogen
cd example/ios && pod install
cd example && yarn ios
cd example && yarn android
```
